name: Build and Package Release

on:
  push:
    tags:
      - "v*" # 当推送v开头的tag时触发（如v2.1.0）
  workflow_dispatch: # 允许手动触发

jobs:
  package:
    permissions:
      contents: write # 显式授予写入权限
    runs-on: ubuntu-latest # 使用GitHub提供的Linux环境
    timeout-minutes: 15 # 设置超时时间
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整提交历史

      # 2. 缓存优化
      # - uses: actions/cache@v3
      #   with:
      #     path: |
      #       package/
      #     key: ${{ runner.os }}-package-${{ hashFiles('scripts/*') }}

      # 3. 创建打包目录（避免包含.git文件夹）
      - name: Prepare files
        run: |
          rm -rf package/  # 强制清理旧目录
          mkdir -p package/{scripts,docs}
          echo "正在复制脚本文件..."
          cp -v scripts/* package/scripts/  # 显示详细复制过程
          [ -d "docs" ] && cp -vr docs/* package/docs/ || echo "无文档目录"
          cp -v README.md package/
          [ -f "LICENSE" ] && cp -v LICENSE package/ || echo "无 LICENSE 文件"

      # 5. 压缩打包（跨平台兼容格式）
      - name: Create ZIP archive
        run: |
          echo "当前目录结构:"
          ls -R
          echo "开始打包..."
          cd package
          zip -r ../GameOptimization_${GITHUB_REF_NAME}.zip *
          echo "打包完成，校验文件..."
          cd ..
          sha256sum GameOptimization_${GITHUB_REF_NAME}.zip > checksum.sha256
          echo "生成文件列表:"
          ls -l

      # 6. 创建 Release 并上传 ZIP 文件
      - name: Create Release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false

      - name: Upload ZIP
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./GameOptimization_${{ github.ref_name }}.zip
          asset_name: GameOptimization_${{ github.ref_name }}.zip
          asset_content_type: application/zip

      # 7. 发送邮件通知
      # - name: Send notification
      #   if: always() # 无论构建成功失败都发送
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.example.com
      #     server_port: 587
      #     username: ${{ secrets.EMAIL_USER }}
      #     password: ${{ secrets.EMAIL_PASSWORD }}
      #     subject: "Release ${{ github.ref_name }} build ${{ job.status }}"
      #     body: |
      #       Build log: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      #       Status: ${{ job.status }}
      #     to: vdavidyang@gmail.com

      # 8. 失败处理
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "Build failed! Check the logs"
